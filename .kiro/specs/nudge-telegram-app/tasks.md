# План реализации: Nudge Telegram Mini App

## Обзор

Этот план реализации разбивает Nudge Telegram Mini App на дискретные, управляемые задачи. Каждая задача инкрементально строится на предыдущей работе, обеспечивая раннюю валидацию основной функциональности через тестирование. План следует подходу снизу вверх: настройка базы данных → backend API → frontend компоненты → интеграция → геймификация.

## Задачи

- [x] 1. Настройка проекта и схемы базы данных
  - Инициализировать проект Nuxt 3 с TypeScript, UnoCSS и Pinia
  - Установить и настроить Drizzle ORM с PostgreSQL
  - Настроить переменные окружения для подключения к БД и токена бота
  - Создать схему базы данных со всеми таблицами (users, contacts, reminders, achievements, user_achievements, activity_logs)
  - Создать и выполнить начальную миграцию
  - _Требования: 6.1, 6.2_

- [ ]* 1.1 Написать property-тест для схемы базы данных
  - **Свойство 2: Круговая проверка сохранения данных контакта**
  - **Проверяет: Требования 1.4, 2.6, 6.1**

- [x] 2. Система аутентификации
  - [x] 2.1 Реализовать валидацию Telegram initData на backend
    - Создать endpoint `/api/auth`
    - Реализовать валидацию подписи HMAC-SHA256 с использованием токена бота
    - Создать или получить пользователя из БД на основе Telegram ID
    - Вернуть токен сессии или данные пользователя
    - _Требования: 1.1, 1.2_

  - [ ]* 2.2 Написать property-тест для аутентификации
    - **Свойство 1: Валидация подписи аутентификации**
    - **Проверяет: Требования 1.1, 1.2**

  - [ ]* 2.3 Написать unit-тест для ошибок аутентификации
    - Тест отклонения неверной подписи
    - Тест обработки отсутствующих полей
    - _Требования: 1.5_

  - [x] 2.4 Создать composable useTelegramAuth
    - Извлечь initData из Telegram Web App SDK
    - Вызвать API аутентификации
    - Сохранить сессию пользователя в Pinia auth store
    - Обработать ошибки аутентификации
    - _Требования: 1.1, 1.2_

- [x] 3. Backend управления контактами
  - [x] 3.1 Реализовать CRUD API endpoints для контактов
    - `GET /api/contacts` - Список всех контактов пользователя
    - `POST /api/contacts` - Добавить новый контакт
    - `PUT /api/contacts/:id` - Обновить настройки контакта
    - `DELETE /api/contacts/:id` - Удалить контакт
    - `GET /api/contacts/:id` - Получить детали контакта
    - _Требования: 2.1, 2.2, 2.6, 2.7_

  - [ ]* 3.2 Написать property-тест для конфигурации контакта
    - **Свойство 3: Валидация конфигурации контакта**
    - **Проверяет: Требования 2.3, 2.4, 2.5**

  - [ ]* 3.3 Написать property-тест для сохранения контакта
    - **Свойство 2: Круговая проверка сохранения данных контакта**
    - **Проверяет: Требования 1.4, 2.6, 6.1**

  - [x] 3.2 Реализовать логику импорта контактов
    - Создать endpoint для получения импортированных данных контактов
    - Валидировать и санитизировать информацию о контактах
    - Сохранить контакты с настройками по умолчанию
    - _Требования: 1.4_

- [x] 4. Система расчета напоминаний
  - [x] 4.1 Реализовать функции расчета напоминаний
    - Создать функцию `calculateNextReminderDate()`
    - Создать вспомогательную функцию `getFrequencyInDays()`
    - Создать функцию для определения контактов, требующих напоминания
    - _Требования: 3.1, 3.2_

  - [ ]* 4.2 Написать property-тест для расчета напоминаний
    - **Свойство 4: Согласованность расчета напоминаний**
    - **Проверяет: Требования 3.1, 7.1**

  - [ ]* 4.3 Написать property-тест для определения контактов
    - **Свойство 5: Идентификация контактов, требующих напоминания**
    - **Проверяет: Требования 3.2, 3.4**

  - [x] 4.4 Создать API endpoints для напоминаний
    - `GET /api/reminders` - Получить сегодняшние напоминания
    - `POST /api/reminders/:id/complete` - Отметить напоминание выполненным
    - _Требования: 3.4, 3.5, 3.6_

  - [ ]* 4.5 Написать property-тест для завершения напоминания
    - **Свойство 6: Эффекты завершения напоминания**
    - **Проверяет: Требования 3.5, 3.6**

- [x] 5. Контрольная точка - Основной Backend завершен
  - Убедиться, что все тесты проходят, спросить пользователя, если возникнут вопросы.

- [x] 6. Backend системы геймификации
  - [x] 6.1 Реализовать логику расчета стриков
    - Создать функцию `updateStreak()`
    - Обработать последовательные дни, пропуски и завершения в тот же день
    - Обновлять longestStreak при необходимости
    - _Требования: 4.1, 4.2_

  - [ ]* 6.2 Написать property-тест для расчета стриков
    - **Свойство 7: Логика расчета стриков**
    - **Проверяет: Требования 4.1, 4.2**

  - [x] 6.3 Реализовать систему XP и уровней
    - Создать функцию `awardXP()` с маппингом типов действий
    - Создать функцию `calculateLevel()`
    - Создать функцию логирования активности
    - _Требования: 4.3, 4.4, 4.5, 4.6, 4.7_

  - [ ]* 6.4 Написать property-тест для начисления XP
    - **Свойство 8: Согласованность начисления XP**
    - **Проверяет: Требования 4.3, 4.4, 4.5, 4.6**

  - [ ]* 6.5 Написать property-тест для расчета уровня
    - **Свойство 9: Формула расчета уровня**
    - **Проверяет: Требования 4.7**

  - [x] 6.6 Реализовать систему достижений
    - Создать seed-данные для таблицы достижений
    - Создать функцию `checkAchievements()`
    - Создать функцию `unlockAchievement()`
    - _Требования: 4.8_

  - [ ]* 6.7 Написать property-тест для разблокировки достижений
    - **Свойство 10: Критерии разблокировки достижений**
    - **Проверяет: Требования 4.8**

  - [x] 6.8 Создать API endpoints для геймификации
    - `GET /api/gamification/stats` - Получить статистику пользователя
    - `GET /api/gamification/achievements` - Получить достижения
    - _Требования: 4.9, 4.10_

- [x] 7. Frontend - Страница Dashboard
  - [x] 7.1 Создать компонент страницы Dashboard
    - Отобразить виджет сегодняшних напоминаний
    - Отобразить текущий стрик, XP, уровень и прогресс-бар
    - Отобразить график/диаграмму активности
    - Реализовать действие завершения напоминания
    - _Требования: 3.4, 4.9, 5.1_

  - [x] 7.2 Создать composable useReminders
    - Получить сегодняшние напоминания из API
    - Обработать завершение напоминания
    - Обновить локальное состояние после завершения
    - _Требования: 3.4, 3.5, 3.6_

  - [x] 7.3 Создать composable useGamification
    - Получить статистику пользователя из API
    - Получить достижения из API
    - Предоставить реактивное состояние для UI
    - _Требования: 4.9, 4.10_

- [x] 8. Frontend - Управление контактами
  - [x] 8.1 Создать страницу списка контактов
    - Отобразить все контакты с поиском/фильтрацией
    - Показать статус отслеживания для каждого контакта
    - Навигация на страницу деталей контакта
    - _Требования: 2.1_

  - [x] 8.2 Создать страницу деталей контакта
    - Отобразить информацию о контакте
    - Показать форму конфигурации (частота, тип, категория)
    - Показать историю взаимодействий
    - Разрешить ручное обновление даты последнего контакта
    - Обработать обновления настроек контакта
    - _Требования: 2.2, 2.3, 2.4, 2.5, 2.6, 2.7_

  - [x] 8.3 Создать composable useContacts
    - Получить контакты из API
    - Обработать CRUD операции с контактами
    - Управлять состоянием контактов в Pinia store
    - _Требования: 2.1, 2.2, 2.6_

- [x] 9. Frontend - Страница достижений
  - [x] 9.1 Создать компонент страницы достижений
    - Отобразить все достижения с состояниями заблокировано/разблокировано
    - Показать прогресс к заблокированным достижениям
    - Отобразить детали достижений (название, описание, награда XP)
    - _Требования: 4.10, 5.3_

  - [ ]* 9.2 Написать property-тест для расчета прогресса достижений
    - **Свойство 10: Критерии разблокировки достижений** (аспект расчета прогресса)
    - **Проверяет: Требования 5.3**

- [x] 10. Планировщик уведомлений
  - [x] 10.1 Реализовать планировщик напоминаний на основе cron
    - Настроить задачу node-cron для ежедневного запуска
    - Рассчитать напоминания для всех пользователей
    - Сгенерировать запросы на уведомления
    - _Требования: 7.1, 7.2_

  - [x] 10.2 Реализовать отправку уведомлений через Telegram Bot
    - Создать экземпляр бота с токеном
    - Реализовать функцию отправки уведомлений
    - Обработать сбои уведомлений с логикой повтора
    - Логировать события уведомлений
    - _Требования: 3.3, 7.3, 7.4_

  - [ ]* 10.3 Написать unit-тесты для планировщика
    - Тест триггера расчета напоминаний
    - Тест генерации запросов на уведомления
    - _Требования: 7.1, 7.2_

- [x] 11. Контрольная точка - Основные функции завершены
  - Убедиться, что все тесты проходят, спросить пользователя, если возникнут вопросы.

- [x] 12. Интеграция Webhook
  - [x] 12.1 Реализовать endpoint webhook
    - Создать endpoint `POST /api/webhook`
    - Валидировать подпись webhook
    - Парсить команды бота
    - Обработать команды завершения
    - _Требования: 9.1, 9.2, 9.3_

  - [ ]* 12.2 Написать property-тест для валидации webhook
    - **Свойство 13: Валидация подписи Webhook**
    - **Проверяет: Требования 9.2**

  - [ ]* 12.3 Написать property-тест для обработки команд
    - **Свойство 14: Обработка команд бота**
    - **Проверяет: Требования 9.3**

  - [ ]* 12.4 Написать unit-тест для обработки ошибок webhook
    - Тест отклонения неверной подписи
    - Тест обработки некорректного payload
    - _Требования: 9.4_

- [x] 13. Визуализация активности
  - [x] 13.1 Реализовать логику агрегации активности
    - Создать функцию для агрегации логов активности по временным периодам
    - Подсчитать завершенные напоминания за неделю/месяц
    - _Требования: 5.2_

  - [ ]* 13.2 Написать property-тест для агрегации активности
    - **Свойство 11: Точность агрегации активности**
    - **Проверяет: Требования 5.2**

  - [x] 13.3 Создать компонент графика активности
    - Отобразить данные активности в виде графика/диаграммы
    - Разрешить переключение между недельным и месячным видами
    - _Требования: 5.1, 5.2_

- [x] 14. Тестирование сохранения данных
  - [x]* 14.1 Написать property-тест для сохранения сессии
    - **Свойство 12: Сохранение данных между сессиями**
    - **Проверяет: Требования 6.2**

  - [x]* 14.2 Написать unit-тесты для обработки ошибок
    - Тест сбоев подключения к базе данных
    - Тест логирования ошибок
    - Тест пользовательских сообщений об ошибках
    - _Требования: 6.3_

- [x] 15. Доработка UI и обработка ошибок
  - [x] 15.1 Реализовать состояния загрузки
    - Добавить индикаторы загрузки для всех асинхронных операций
    - Реализовать skeleton screens для загрузки данных
    - _Требования: 8.3_

  - [x] 15.2 Реализовать UI обработки ошибок
    - Создать компоненты сообщений об ошибках
    - Отображать понятные пользователю сообщения об ошибках
    - Добавить механизмы повтора для неудачных операций
    - _Требования: 8.4_

  - [x] 15.3 Реализовать управление состоянием
    - Обеспечить сохранение состояния при навигации между страницами
    - Реализовать оптимистичные обновления для лучшего UX
    - _Требования: 8.1_

- [ ] 16. Финальная интеграция и тестирование
  - [ ] 16.1 End-to-end интеграционное тестирование
    - Тест полного пользовательского потока: auth → импорт → настройка → напоминания → завершение
    - Тест потока геймификации: начисление XP → повышение уровня → достижения
    - Тест потока уведомлений: планировщик → бот → webhook → завершение
    - _Требования: Все_

  - [ ] 16.2 Оптимизация производительности
    - Добавить индексы базы данных
    - Реализовать кэширование где необходимо
    - Оптимизировать время ответа API
    - _Требования: 6.1, 6.2_

- [ ] 17. Финальная контрольная точка - Готово к продакшену
  - Убедиться, что все тесты проходят, спросить пользователя, если возникнут вопросы.

## Примечания

- Задачи, помеченные `*`, являются необязательными и могут быть пропущены для более быстрого MVP
- Каждая задача ссылается на конкретные требования для отслеживаемости
- Контрольные точки обеспечивают инкрементальную валидацию
- Property-тесты проверяют универсальные свойства корректности
- Unit-тесты проверяют конкретные примеры и граничные случаи
- Реализация следует подходу снизу вверх: база данных → backend → frontend → интеграция

## Языковые требования

**ВАЖНО:** При выполнении всех задач:
- Все комментарии в коде должны быть на русском языке
- Все сообщения коммитов должны быть на русском языке
- Все описания функций и документация должны быть на русском языке
- Все сообщения об ошибках для пользователей должны быть на русском языке
- Все логи и отладочные сообщения должны быть на русском языке
- Все отчеты о выполнении задач должны быть на русском языке
- Названия переменных, функций и классов остаются на английском (стандарт кодирования)
- Строковые литералы для UI должны быть на русском языке

## Стандарты кодирования

**ОБЯЗАТЕЛЬНО:** Во всем проекте должен использоваться единообразный подход:

### Vue 3 Composition API
- **Все компоненты** должны использовать `<script setup>` синтаксис с Composition API
- **Все Pinia stores** должны использовать Composition API стиль (setup stores)
- **НЕ использовать** Options API (`data()`, `methods`, `computed` в объекте)
- **НЕ использовать** Options API стиль для stores (`state()`, `actions`, `getters` в объекте)

### Примеры правильного использования:

**Компонент (правильно):**
```vue
<script setup lang="ts">
import { ref, computed } from 'vue'

const count = ref(0)
const doubled = computed(() => count.value * 2)

function increment() {
  count.value++
}
</script>
```

**Store (правильно):**
```typescript
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'

export const useAuthStore = defineStore('auth', () => {
  const user = ref(null)
  const isAuthenticated = computed(() => !!user.value)
  
  function login(userData) {
    user.value = userData
  }
  
  return { user, isAuthenticated, login }
})
```

### Что НЕ делать:

**Компонент (неправильно):**
```vue
<script lang="ts">
export default {
  data() {
    return { count: 0 }
  },
  computed: {
    doubled() { return this.count * 2 }
  }
}
</script>
```

**Store (неправильно):**
```typescript
export const useAuthStore = defineStore('auth', {
  state: () => ({ user: null }),
  getters: {
    isAuthenticated: (state) => !!state.user
  },
  actions: {
    login(userData) { this.user = userData }
  }
})
```
