# План реализации: Социальные события и уведомления

## Обзор

Реализация социальных связей, событий с приглашениями и push-уведомлений через Telegram. План разбит на логические этапы с инкрементальной интеграцией.

## Задачи

- [x] 1. Расширение схемы базы данных
  - [x] 1.1 Добавить колонки linkedUserId и isMutual в таблицу contacts
    - Создать миграцию для обновления таблицы contacts
    - Добавить внешний ключ на таблицу users
    - _Требования: 1.1, 2.4, 3.3_
  - [x] 1.2 Создать таблицу events
    - Определить все колонки: id, organizerId, title, type, customType, description, startDate, endDate, duration, status, isRecurring, recurrencePattern, recurrenceInterval, parentEventId, reminderMinutes, timestamps
    - _Требования: 4.1, 5.1, 8.1_
  - [x] 1.3 Создать таблицу event_participants
    - Определить колонки: id, eventId, contactId, status, respondedAt, createdAt
    - Добавить внешние ключи на events и contacts
    - _Требования: 6.1, 6.4_
  - [x] 1.4 Создать таблицу invitations
    - Определить колонки: id, eventId, inviterId, inviteeId, status, respondedAt, createdAt
    - Добавить внешние ключи на events и users
    - _Требования: 7.1_
  - [x] 1.5 Создать таблицу notification_settings
    - Определить колонки с дефолтными значениями для всех типов уведомлений
    - Добавить уникальное ограничение на userId
    - _Требования: 12.1, 12.2, 12.3_
  - [x] 1.6 Запустить миграции и обновить экспорты схемы
    - Сгенерировать файлы миграций
    - Обновить schema.ts с новыми таблицами и типами
    - _Требования: 1.1, 4.1, 6.1, 7.1, 12.1_

- [x] 2. Функционал связывания контактов
  - [x] 2.1 Обновить API создания контакта для проверки связанных пользователей
    - Модифицировать POST /api/contacts для поиска telegramContactId в таблице users
    - Установить linkedUserId если пользователь найден
    - _Требования: 1.1_
  - [x] 2.2 Создать утилиту проверки взаимных связей
    - Функция для проверки и обновления взаимных связей
    - Обновить обе записи контактов при обнаружении взаимности
    - _Требования: 2.4, 3.3_
  - [ ]* 2.3 Написать property-тест для симметрии взаимных связей
    - **Свойство 4: Симметрия взаимных связей**
    - **Проверяет: Требования 2.4, 3.1, 3.3**
  - [x] 2.4 Создать эндпоинт GET /api/connections/added-by
    - Запрос контактов где linkedUserId = текущий пользователь
    - Вернуть информацию о пользователе для каждой связи
    - _Требования: 2.1, 2.2, 2.3_
  - [x] 2.5 Создать эндпоинт GET /api/connections/mutual
    - Запрос контактов где isMutual = true
    - _Требования: 3.2_
  - [ ]* 2.6 Написать property-тест для корректности списка "добавили меня"
    - **Свойство 3: Корректность списка added-by**
    - **Проверяет: Требования 2.1, 2.2, 2.3**

- [x] 3. Контрольная точка - Проверка связывания контактов
  - Убедиться что все тесты проходят, спросить пользователя если есть вопросы.

- [x] 4. CRUD API для событий
  - [x] 4.1 Создать утилиту валидации событий
    - Валидация title, type, dates, duration
    - Обработка валидации кастомного типа
    - _Требования: 4.1, 4.2, 4.3, 4.4, 4.5_
  - [ ]* 4.2 Написать property-тест для валидации событий
    - **Свойство 6: Валидация создания события**
    - **Проверяет: Требования 4.1, 4.2, 4.4, 4.5**
  - [x] 4.3 Создать эндпоинт POST /api/events
    - Создание события с валидацией
    - Добавление участников если указаны
    - Создание приглашений для связанных контактов
    - _Требования: 4.1, 6.1, 6.2, 6.3_
  - [x] 4.4 Создать эндпоинт GET /api/events
    - Список событий пользователя (как организатор или участник)
    - Поддержка фильтрации по статусу, диапазону дат
    - _Требования: 9.5_
  - [x] 4.5 Создать эндпоинт GET /api/events/[id]
    - Вернуть событие с участниками
    - _Требования: 4.1_
  - [x] 4.6 Создать эндпоинт PUT /api/events/[id]
    - Обновление события (только организатор)
    - Обработка изменений участников
    - _Требования: 8.4_
  - [x] 4.7 Создать эндпоинт DELETE /api/events/[id]
    - Удаление события (только организатор)
    - Каскадное удаление участников и приглашений
    - _Требования: 8.4_
  - [x] 4.8 Создать эндпоинт POST /api/events/[id]/cancel
    - Установить статус cancelled
    - Отправить уведомления участникам
    - _Требования: 8.5_
  - [ ]* 4.9 Написать property-тест для фильтра предстоящих событий
    - **Свойство 15: Фильтр предстоящих событий**
    - **Проверяет: Требования 9.5**

- [x] 5. Функционал повторяющихся событий
  - [x] 5.1 Создать утилиту генерации повторений
    - Генерация дат по паттерну (daily, weekly, monthly, custom)
    - Обработка кастомного интервала
    - _Требования: 5.1, 5.2, 5.3_
  - [ ]* 5.2 Написать property-тест для генерации повторений
    - **Свойство 9: Корректность генерации повторений**
    - **Проверяет: Требования 5.3**
  - [x] 5.3 Интегрировать повторения в создание событий
    - Создание дочерних событий для повторяющихся
    - Связь через parentEventId
    - _Требования: 5.3_

- [x] 6. Контрольная точка - Проверка API событий
  - Убедиться что все тесты проходят, спросить пользователя если есть вопросы.

- [x] 7. API приглашений
  - [x] 7.1 Создать эндпоинт GET /api/invitations
    - Список ожидающих приглашений для текущего пользователя
    - Включить детали события
    - _Требования: 7.1_
  - [ ]* 7.2 Написать property-тест для запроса ожидающих приглашений
    - **Свойство 12: Запрос ожидающих приглашений**
    - **Проверяет: Требования 7.1**
  - [x] 7.3 Создать эндпоинт POST /api/invitations/[id]/respond
    - Принять или отклонить приглашение
    - Обновить статус участника
    - _Требования: 7.3, 7.4_
  - [ ]* 7.4 Написать property-тест для синхронизации ответа на приглашение
    - **Свойство 11: Синхронизация ответа на приглашение**
    - **Проверяет: Требования 7.3, 7.4**

- [x] 8. Управление статусами событий
  - [x] 8.1 Создать плагин обновления статусов событий
    - Запланированная задача для обновления статусов
    - Переходы scheduled → in_progress → completed
    - _Требования: 8.2, 8.3_
  - [ ]* 8.2 Написать property-тест для переходов статусов
    - **Свойство 13: Переходы статусов событий**
    - **Проверяет: Требования 8.1, 8.2, 8.3**

- [x] 9. Сервис уведомлений
  - [x] 9.1 Создать класс NotificationService
    - Методы для каждого типа уведомлений
    - Отправка сообщений через Telegram бота
    - Логика повторных попыток с backoff
    - _Требования: 11.1, 11.6_
  - [ ]* 9.2 Написать property-тест для логики повторных попыток
    - **Свойство 21: Логика повторных попыток уведомлений**
    - **Проверяет: Требования 11.6**
  - [x] 9.3 Создать планировщик напоминаний
    - Расчёт времени напоминаний на основе настроек события
    - Планирование уведомлений
    - _Требования: 11.2_
  - [ ]* 9.4 Написать property-тест для расчёта времени напоминания
    - **Свойство 18: Расчёт времени напоминания**
    - **Проверяет: Требования 11.2**
  - [x] 9.5 Создать API настроек уведомлений
    - GET /api/notifications/settings
    - PUT /api/notifications/settings
    - _Требования: 11.4, 12.1, 12.2_
  - [ ]* 9.6 Написать property-тест для учёта предпочтений уведомлений
    - **Свойство 20: Учёт предпочтений уведомлений**
    - **Проверяет: Требования 12.4**

- [x] 10. Контрольная точка - Проверка бэкенд функционала
  - Убедиться что все тесты проходят, спросить пользователя если есть вопросы.

- [x] 11. Фронтенд: UI связывания контактов
  - [x] 11.1 Создать компонент LinkedBadge
    - Бейдж для связанных контактов
    - Разные иконки для взаимных связей
    - _Требования: 1.2, 1.3, 3.1_
  - [x] 11.2 Обновить карточки контактов для отображения LinkedBadge
    - Добавить бейдж к аватару в списке контактов
    - Добавить бейдж на странице деталей контакта
    - _Требования: 1.2, 1.3_
  - [x] 11.3 Создать страницу связей (/connections)
    - Вкладки: "Добавили меня" / "Взаимные"
    - Список с кнопкой "добавить в ответ"
    - _Требования: 2.1, 2.3, 3.2_
  - [x] 11.4 Добавить composable useConnections
    - Получение списков added-by и mutual
    - _Требования: 2.1, 3.2_

- [x] 12. Фронтенд: UI событий
  - [x] 12.1 Создать компонент EventCard
    - Отображение названия, иконки типа, даты, участников
    - Соответствие стилю приложения
    - _Требования: 9.3, 13.1-13.6_
  - [x] 12.2 Создать компонент EventForm
    - Форма создания/редактирования событий
    - Селектор типа с кастомной опцией
    - Выбор даты/времени, продолжительности
    - Опции повторения
    - Выбор участников
    - _Требования: 4.1, 4.2, 4.3, 5.1, 5.2, 6.1_
  - [x] 12.3 Создать страницу создания события (/events/create)
    - Использовать компонент EventForm
    - Навигация с кнопки "+"
    - _Требования: 4.6_
  - [x] 12.4 Создать страницу деталей события (/events/[id])
    - Показать информацию о событии, участников, статус
    - Кнопки редактирования/отмены для организатора
    - _Требования: 4.1, 6.4, 8.4_
  - [x] 12.5 Добавить composable useEvents
    - CRUD операции для событий
    - Запрос предстоящих событий
    - _Требования: 4.1, 9.5_

- [x] 13. Фронтенд: UI календаря
  - [x] 13.1 Создать компонент CalendarModal
    - Вид месяца с ячейками дней
    - Индикаторы событий на днях
    - Выбор дня показывает события
    - _Требования: 10.2, 10.3, 10.5_
  - [x] 13.2 Добавить composable useCalendar
    - Навигация по месяцам
    - Запросы событий по датам
    - _Требования: 10.4_
  - [x] 13.3 Подключить календарь к иконке уведомлений
    - Открывать CalendarModal по клику на иконку
    - _Требования: 10.1_

- [x] 14. Фронтенд: Обновления главной страницы
  - [x] 14.1 Добавить секцию предстоящих событий
    - Горизонтальный скролл EventCard
    - Показать события на ближайшие 7 дней
    - _Требования: 9.1, 9.2, 9.5_
  - [x] 14.2 Обновить кнопку "+" для создания события
    - Навигация на /events/create
    - _Требования: 4.6_
  - [x] 14.3 Обновить функционал иконки уведомлений
    - Открывать CalendarModal по клику
    - _Требования: 10.1_

- [x] 15. Фронтенд: UI приглашений
  - [x] 15.1 Создать компонент InvitationCard
    - Показать информацию о событии, пригласившего
    - Кнопки принять/отклонить
    - _Требования: 7.1, 7.3_
  - [x] 15.2 Создать секцию/страницу приглашений
    - Список ожидающих приглашений
    - _Требования: 7.1_
  - [x] 15.3 Добавить composable useInvitations
    - Получение и ответ на приглашения
    - _Требования: 7.1, 7.3_

- [x] 16. Фронтенд: Настройки уведомлений
  - [x] 16.1 Создать компонент NotificationSettings
    - Переключатели для каждого типа уведомлений
    - Селектор времени напоминания
    - _Требования: 12.1, 12.2_
  - [x] 16.2 Добавить настройки на страницу профиля
    - Включить компонент NotificationSettings
    - _Требования: 11.4_

- [x] 17. Финальная контрольная точка
  - Убедиться что все тесты проходят, спросить пользователя если есть вопросы.
  - Проверить мобильную адаптивность
  - Проверить консистентность дизайна

- [x] 18. Подготовка к production
  - [x] 18.1 Проверить и обновить миграции для production
    - Убедиться что все миграции корректно применяются
    - Проверить совместимость с существующими данными
  - [x] 18.2 Настроить переменные окружения
    - Документировать новые переменные (если есть)
    - Проверить конфигурацию для Render/production
  - [x] 18.3 Провести финальное тестирование
    - Запустить все тесты в production-like окружении
    - Проверить работу с реальным Telegram Bot API

## Примечания

- Задачи с `*` — опциональные property-тесты
- Каждая задача ссылается на конкретные требования для трассировки
- Контрольные точки обеспечивают инкрементальную валидацию
- Фронтенд задачи зависят от завершения бэкенд API

## Важно: Работа с базой данных

**После удаления Docker volumes или первого запуска:**
1. Запустить контейнеры: `make dev`
2. Выполнить миграции: `make migrate-dev`

**Плагины сервера должны быть устойчивы к отсутствию таблиц:**
- Проверять существование таблиц перед запросами
- Не бросать ошибки, блокирующие запуск сервера
- Выводить понятные сообщения о необходимости миграций
