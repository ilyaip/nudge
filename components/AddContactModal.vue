<template>
  <Teleport to="body">
    <Transition name="modal-backdrop">
      <div
        v-if="isOpen"
        class="fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50"
        @click.self="handleClose"
      >
        <Transition name="modal-content" appear>
          <div 
            v-if="isOpen"
            class="bg-white rounded-t-3xl sm:rounded-3xl shadow-xl w-full sm:max-w-md max-h-[85vh] overflow-hidden flex flex-col"
          >
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
      <div class="sticky top-0 bg-white px-4 py-4 flex items-center justify-between border-b border-gray-100">
        <h2 class="text-xl font-bold text-text">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</h2>
        <button
          @click="handleClose"
          class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors"
        >
          <svg class="w-5 h-5 text-textSecondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
      <div class="flex-1 overflow-y-auto p-4 space-y-4">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–º–ø–æ—Ä—Ç–µ -->
        <div class="bg-primary/5 border border-primary/20 rounded-2xl p-4">
          <p class="text-sm text-primary font-semibold mb-2">üí° –ö–∞–∫ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å:</p>
          <ol class="text-sm text-textSecondary space-y-1 list-decimal list-inside">
            <li>–ù–∞–∂–º–∏—Ç–µ "–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å"</li>
            <li>–û—Ç–∫—Ä–æ–µ—Ç—Å—è —á–∞—Ç —Å –±–æ—Ç–æ–º</li>
            <li>üìé ‚Üí –ö–æ–Ω—Ç–∞–∫—Ç</li>
            <li>–í—ã–±–µ—Ä–∏—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ</li>
          </ol>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∏–∑ Telegram -->
        <button
          @click="handleImportFromTelegram"
          class="w-full gradient-purple-bright hover:opacity-90 text-white px-4 py-3.5 rounded-2xl font-semibold transition-all flex items-center justify-center gap-2 shadow-sm"
        >
          <span class="text-lg">üì±</span>
          <span>–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ Telegram</span>
        </button>

        <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
        <div class="relative py-2">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-gray-200"></div>
          </div>
          <div class="relative flex justify-center">
            <span class="px-3 bg-white text-sm text-textSecondary">–∏–ª–∏ –≤—Ä—É—á–Ω—É—é</span>
          </div>
        </div>

        <!-- –§–æ—Ä–º–∞ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ -->
        <div class="space-y-4">
          <!-- –ò–º—è -->
          <div>
            <label class="block text-sm font-semibold text-text mb-1.5">
              –ò–º—è <span class="text-red-500">*</span>
            </label>
            <input
              v-model="formData.name"
              type="text"
              placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
              class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all text-base bg-white"
              :class="{ 'border-red-400 focus:ring-red-400': errors.name }"
            />
            <p v-if="errors.name" class="text-red-500 text-xs mt-1">{{ errors.name }}</p>
          </div>

          <!-- Username -->
          <div>
            <label class="block text-sm font-semibold text-text mb-1.5">
              Username –≤ Telegram
            </label>
            <div class="relative">
              <span class="absolute left-4 top-3 text-textSecondary">@</span>
              <input
                v-model="formData.username"
                type="text"
                placeholder="username"
                class="w-full pl-9 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all text-base bg-white"
              />
            </div>
          </div>

          <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
          <div>
            <label class="block text-sm font-semibold text-text mb-1.5">
              –ö–∞—Ç–µ–≥–æ—Ä–∏—è <span class="text-red-500">*</span>
            </label>
            <select
              v-model="formData.category"
              class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all text-base bg-white appearance-none"
            >
              <option value="friends">üë• –î—Ä—É–∑—å—è</option>
              <option value="family">üë®‚Äçüë©‚Äçüëß –°–µ–º—å—è</option>
              <option value="colleagues">üíº –ö–æ–ª–ª–µ–≥–∏</option>
              <option value="business">ü§ù –ë–∏–∑–Ω–µ—Å</option>
            </select>
          </div>

          <!-- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç -->
          <div class="flex items-center gap-3 p-4 bg-backgroundSecondary rounded-2xl">
            <input
              v-model="formData.isTracked"
              type="checkbox"
              id="isTracked"
              class="w-5 h-5 text-primary rounded-lg border-gray-300 focus:ring-2 focus:ring-primary"
            />
            <label for="isTracked" class="text-sm font-semibold text-text cursor-pointer">
              –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
            </label>
          </div>

          <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è -->
          <div v-if="formData.isTracked" class="space-y-4 p-4 bg-primary/5 rounded-2xl">
            <!-- –ß–∞—Å—Ç–æ—Ç–∞ -->
            <div>
              <label class="block text-sm font-semibold text-text mb-1.5">
                –ß–∞—Å—Ç–æ—Ç–∞ —Å–≤—è–∑–∏
              </label>
              <select
                v-model="formData.frequency"
                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all text-base bg-white appearance-none"
              >
                <option value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
                <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
                <option value="quarterly">–ï–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ</option>
                <option value="custom">–°–≤–æ—è —á–∞—Å—Ç–æ—Ç–∞</option>
              </select>
            </div>

            <!-- –ö–∞—Å—Ç–æ–º–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ -->
            <div v-if="formData.frequency === 'custom'">
              <label class="block text-sm font-semibold text-text mb-1.5">
                –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π
              </label>
              <input
                v-model.number="formData.customFrequencyDays"
                type="number"
                min="1"
                placeholder="14"
                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all text-base bg-white"
              />
            </div>

            <!-- –¢–∏–ø –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ -->
            <div>
              <label class="block text-sm font-semibold text-text mb-1.5">
                –¢–∏–ø –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
              </label>
              <select
                v-model="formData.communicationType"
                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all text-base bg-white appearance-none"
              >
                <option value="message">üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ</option>
                <option value="call">üìû –ó–≤–æ–Ω–æ–∫</option>
                <option value="meeting">ü§ù –í—Å—Ç—Ä–µ—á–∞</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- –§—É—Ç–µ—Ä —Å –∫–Ω–æ–ø–∫–∞–º–∏ -->
      <div class="sticky bottom-0 bg-white border-t border-gray-100 px-4 py-4 flex gap-3">
        <button
          @click="handleClose"
          class="flex-1 px-4 py-3 border border-gray-200 rounded-xl font-semibold text-text hover:bg-gray-50 transition-all"
        >
          –û—Ç–º–µ–Ω–∞
        </button>
        <button
          v-ripple
          @click="handleSubmit"
          :disabled="isSubmitting || !isFormValid"
          class="flex-1 px-4 py-3 bg-primary hover:bg-primaryLight disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-xl font-semibold transition-all flex items-center justify-center gap-2"
        >
          <LoadingSpinner v-if="isSubmitting" size="small" color="white" />
          <span>{{ isSubmitting ? '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...' : '–î–æ–±–∞–≤–∏—Ç—å' }}</span>
        </button>
      </div>
      </div>
        </Transition>
      </div>
    </Transition>
  </Teleport>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'
import type { CreateContactData } from '~/composables/useContacts'

// Props
interface Props {
  isOpen: boolean
}

const props = defineProps<Props>()

// Emits
const emit = defineEmits<{
  close: []
  submit: [data: CreateContactData]
}>()

// –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
const mode = ref<'manual' | 'telegram'>('manual')
const isSubmitting = ref(false)
const selectedTelegramContact = ref<any>(null)

// –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
const formData = ref<CreateContactData>({
  telegramContactId: '',
  name: '',
  username: '',
  category: 'friends',
  isTracked: false,
  frequency: 'monthly',
  customFrequencyDays: undefined,
  communicationType: 'message'
})

// –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
const errors = ref<Record<string, string>>({})

/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—ã
 */
const isFormValid = computed(() => {
  return formData.value.name.trim().length > 0
})

/**
 * –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏–∑ Telegram
 */
const handleImportFromTelegram = () => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Telegram Web App API
  if (!window.Telegram?.WebApp) {
    alert('Telegram Web App API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.')
    return
  }

  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  handleClose()

  // –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç —Å –±–æ—Ç–æ–º —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
  const botUsername = 'NudgeMeNow_bot'
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º openLink –≤–º–µ—Å—Ç–æ openTelegramLink
  const telegramApp = window.Telegram.WebApp as any
  if (telegramApp.openTelegramLink) {
    telegramApp.openTelegramLink(`https://t.me/${botUsername}?start=import`)
  } else if (telegramApp.openLink) {
    telegramApp.openLink(`https://t.me/${botUsername}?start=import`)
  } else {
    // Fallback - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
    window.open(`https://t.me/${botUsername}?start=import`, '_blank')
  }
}

/**
 * –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
 */
const validateForm = (): boolean => {
  errors.value = {}

  if (mode.value === 'manual') {
    if (!formData.value.name.trim()) {
      errors.value.name = '–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ'
      return false
    }
  }

  if (formData.value.frequency === 'custom' && (!formData.value.customFrequencyDays || formData.value.customFrequencyDays <= 0)) {
    errors.value.customFrequencyDays = '–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π'
    return false
  }

  return true
}

/**
 * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É
 */
const handleSubmit = async () => {
  if (!validateForm()) {
    return
  }

  isSubmitting.value = true

  try {
    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const submitData: CreateContactData = {
      ...formData.value,
      // –î–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π ID
      telegramContactId: formData.value.telegramContactId || `manual_${Date.now()}`
    }

    // –£–±–∏—Ä–∞–µ–º customFrequencyDays –µ—Å–ª–∏ –Ω–µ custom
    if (submitData.frequency !== 'custom') {
      submitData.customFrequencyDays = undefined
    }

    emit('submit', submitData)
  } catch (error) {
    console.error('[AddContactModal] Submit error:', error)
  } finally {
    isSubmitting.value = false
  }
}

/**
 * –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
 */
const handleClose = () => {
  emit('close')
}

/**
 * –°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ä–º—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
 */
watch(() => props.isOpen, (newValue) => {
  if (!newValue) {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
    mode.value = 'manual'
    selectedTelegramContact.value = null
    formData.value = {
      telegramContactId: '',
      name: '',
      username: '',
      category: 'friends',
      isTracked: false,
      frequency: 'monthly',
      customFrequencyDays: undefined,
      communicationType: 'message'
    }
    errors.value = {}
  }
})
</script>

<style scoped>
/* –°—Ç–∏–ª–∏ –¥–ª—è select —Å –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å—Ç—Ä–µ–ª–∫–æ–π */
select {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 0.75rem center;
  background-repeat: no-repeat;
  background-size: 1.25em 1.25em;
  padding-right: 2.5rem;
}

/* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è input –Ω–∞ iOS */
input[type="text"],
input[type="number"] {
  -webkit-appearance: none;
  appearance: none;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è checkbox */
input[type="checkbox"] {
  -webkit-appearance: none;
  appearance: none;
  background-color: #fff;
  border: 2px solid #d1d5db;
  border-radius: 0.375rem;
  cursor: pointer;
}

input[type="checkbox"]:checked {
  background-color: #6B3CE9;
  border-color: #6B3CE9;
  background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
  background-size: 100% 100%;
  background-position: center;
  background-repeat: no-repeat;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è backdrop */
.modal-backdrop-enter-active,
.modal-backdrop-leave-active {
  transition: opacity 0.3s ease;
}

.modal-backdrop-enter-from,
.modal-backdrop-leave-to {
  opacity: 0;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –º–æ–¥–∞–ª–∫–∏ */
.modal-content-enter-active,
.modal-content-leave-active {
  transition: transform 0.3s ease, opacity 0.3s ease;
}

.modal-content-enter-from {
  transform: translateY(100%);
  opacity: 0;
}

.modal-content-leave-to {
  transform: translateY(100%);
  opacity: 0;
}

@media (min-width: 640px) {
  .modal-content-enter-from {
    transform: scale(0.95) translateY(20px);
  }
  
  .modal-content-leave-to {
    transform: scale(0.95) translateY(20px);
  }
}
</style>
