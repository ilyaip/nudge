# Webhook API

## Обзор

Webhook endpoint для обработки входящих сообщений от Telegram Bot. Позволяет пользователям отмечать напоминания как выполненные через команды бота.

## Endpoint

### POST /api/webhook

Обрабатывает webhook от Telegram Bot API.

#### Безопасность

Endpoint валидирует подпись webhook через заголовок `X-Telegram-Bot-Api-Secret-Token`. Секретный токен должен быть установлен в переменной окружения `TELEGRAM_WEBHOOK_SECRET`.

#### Формат запроса

Telegram Bot API отправляет Update объект в формате JSON:

```json
{
  "update_id": 123456789,
  "message": {
    "message_id": 1,
    "from": {
      "id": 123456789,
      "is_bot": false,
      "first_name": "Иван",
      "username": "ivan"
    },
    "chat": {
      "id": 123456789,
      "first_name": "Иван",
      "type": "private"
    },
    "date": 1234567890,
    "text": "/done @username"
  }
}
```

#### Поддерживаемые команды

##### 1. Завершить все напоминания

```
/done
/complete
```

Отмечает все сегодняшние напоминания пользователя как выполненные.

##### 2. Завершить напоминание для конкретного контакта (по username)

```
/done @username
/complete @username
```

Отмечает напоминание для контакта с указанным Telegram username.

##### 3. Завершить напоминание для конкретного контакта (по имени)

```
/done Иван Петров
/complete Иван Петров
```

Отмечает напоминание для контакта с указанным именем (поиск по частичному совпадению).

#### Формат ответа

##### Успешное выполнение

```json
{
  "success": true,
  "message": "Выполнено напоминаний: 2",
  "completedCount": 2
}
```

##### Нет напоминаний

```json
{
  "success": true,
  "message": "Нет невыполненных напоминаний на сегодня",
  "completedCount": 0
}
```

##### Контакт не найден

```json
{
  "success": false,
  "message": "Контакт @username не найден в сегодняшних напоминаниях"
}
```

#### Коды ошибок

- `400` - Неверный формат webhook payload
- `403` - Неверная подпись webhook
- `404` - Пользователь не найден в базе данных
- `500` - Внутренняя ошибка сервера или токен бота не настроен

## Настройка Webhook

### 1. Установка переменных окружения

Добавьте в `.env`:

```env
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_WEBHOOK_SECRET=your_webhook_secret_here
```

### 2. Регистрация webhook в Telegram

Используйте Telegram Bot API для установки webhook URL:

```bash
curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://your-domain.com/api/webhook",
    "secret_token": "your_webhook_secret_here"
  }'
```

### 3. Проверка webhook

Проверьте статус webhook:

```bash
curl "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getWebhookInfo"
```

## Логика обработки

При получении команды завершения:

1. **Валидация**: Проверяется подпись webhook и формат payload
2. **Аутентификация**: Находится пользователь в БД по Telegram ID
3. **Парсинг команды**: Определяется тип команды и параметры
4. **Получение напоминаний**: Загружаются сегодняшние невыполненные напоминания
5. **Фильтрация**: Если указан контакт, фильтруются напоминания
6. **Завершение**: Для каждого напоминания:
   - Устанавливается `completed = true` и `completedAt = now`
   - Обновляется `lastContactDate` контакта
   - Рассчитывается и устанавливается `nextReminderDate`
7. **Геймификация**: Начисляется XP за выполненные напоминания
8. **Ответ**: Возвращается результат с количеством завершенных напоминаний

## Примеры использования

### Пример 1: Завершить все напоминания

Пользователь отправляет боту:
```
/done
```

Результат:
- Все сегодняшние напоминания отмечены как выполненные
- Обновлены даты последнего контакта для всех контактов
- Начислено XP (20 очков за каждое напоминание)

### Пример 2: Завершить напоминание для конкретного контакта

Пользователь отправляет боту:
```
/done @ivan
```

Результат:
- Напоминание для контакта с username "ivan" отмечено как выполненное
- Обновлена дата последнего контакта
- Начислено 20 XP

### Пример 3: Контакт не найден

Пользователь отправляет боту:
```
/done @nonexistent
```

Результат:
- Возвращается сообщение об ошибке
- Никакие данные не изменяются

## Безопасность

### Валидация подписи

Webhook использует секретный токен для валидации запросов:

1. При регистрации webhook в Telegram указывается `secret_token`
2. Telegram включает этот токен в заголовок `X-Telegram-Bot-Api-Secret-Token`
3. Endpoint сравнивает полученный токен с `TELEGRAM_WEBHOOK_SECRET`
4. Если токены не совпадают, запрос отклоняется с кодом 403

### Рекомендации

- Используйте HTTPS для webhook URL
- Храните `TELEGRAM_WEBHOOK_SECRET` в безопасности
- Регулярно ротируйте секретный токен
- Мониторьте логи на предмет подозрительной активности

## Тестирование

### Локальное тестирование с ngrok

1. Запустите приложение локально
2. Используйте ngrok для создания публичного URL:
   ```bash
   ngrok http 3000
   ```
3. Установите webhook на ngrok URL:
   ```bash
   curl -X POST "https://api.telegram.org/bot<TOKEN>/setWebhook" \
     -d "url=https://your-ngrok-url.ngrok.io/api/webhook"
   ```
4. Отправьте команды боту в Telegram

### Ручное тестирование

Отправьте тестовый webhook запрос:

```bash
curl -X POST "http://localhost:3000/api/webhook" \
  -H "Content-Type: application/json" \
  -H "X-Telegram-Bot-Api-Secret-Token: your_secret" \
  -d '{
    "update_id": 1,
    "message": {
      "message_id": 1,
      "from": {
        "id": 123456789,
        "first_name": "Test",
        "username": "testuser"
      },
      "chat": {
        "id": 123456789,
        "type": "private"
      },
      "date": 1234567890,
      "text": "/done"
    }
  }'
```

## Мониторинг

Endpoint логирует следующие события:

- Получение webhook запроса
- Парсинг команды
- Завершение напоминаний
- Начисление XP
- Ошибки валидации и обработки

Проверяйте логи для отладки:

```bash
# В development режиме
npm run dev

# В production режиме
pm2 logs
```

## Связанные файлы

- `server/api/webhook.post.ts` - Основная логика endpoint
- `server/utils/gamification.ts` - Функции начисления XP
- `server/utils/reminders.ts` - Расчет следующей даты напоминания
- `server/db/schema.ts` - Схема базы данных

## Требования

Реализует следующие требования из спецификации:

- **9.1**: Получение команд от Telegram Bot через webhook
- **9.2**: Валидация подлинности webhook запросов
- **9.3**: Обработка команд завершения напоминаний
- **9.4**: Обработка ошибок и логирование событий безопасности
