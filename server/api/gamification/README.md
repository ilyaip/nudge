# API –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç API endpoints –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Nudge.

## Endpoints

### GET /api/gamification/stats

–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `userId` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "stats": {
    "currentStreak": 5,
    "longestStreak": 10,
    "totalXP": 450,
    "level": 3,
    "xpForNextLevel": 900,
    "xpProgress": 0.5,
    "lastActivityDate": "2024-01-15T00:00:00.000Z"
  }
}
```

**–ü–æ–ª—è –æ—Ç–≤–µ—Ç–∞:**
- `currentStreak` - –¢–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–∫ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–Ω–µ–π)
- `longestStreak` - –°–∞–º—ã–π –¥–ª–∏–Ω–Ω—ã–π —Å—Ç—Ä–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `totalXP` - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–≥–æ XP
- `level` - –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `xpForNextLevel` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ XP, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
- `xpProgress` - –ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É—Ä–æ–≤–Ω—é (–æ—Ç 0 –¥–æ 1)
- `lastActivityDate` - –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

**–ö–æ–¥—ã –æ—à–∏–±–æ–∫:**
- `400` - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä userId
- `404` - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
- `500` - –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

---

### GET /api/gamification/achievements

–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `userId` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "achievements": [
    {
      "id": 1,
      "code": "FIRST_CONTACT",
      "name": "–ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç",
      "description": "–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è",
      "icon": "üë§",
      "xpReward": 10,
      "criteria": { "minContacts": 1 },
      "unlocked": true,
      "unlockedAt": "2024-01-10T12:00:00.000Z"
    },
    {
      "id": 2,
      "code": "SOCIAL_BUTTERFLY",
      "name": "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –±–∞–±–æ—á–∫–∞",
      "description": "–î–æ–±–∞–≤—å—Ç–µ 10 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è",
      "icon": "ü¶ã",
      "xpReward": 50,
      "criteria": { "minContacts": 10 },
      "unlocked": false,
      "unlockedAt": null
    }
  ]
}
```

**–ü–æ–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:**
- `id` - ID –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
- `code` - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
- `name` - –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
- `description` - –û–ø–∏—Å–∞–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
- `icon` - –ò–∫–æ–Ω–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è (emoji)
- `xpReward` - –ù–∞–≥—Ä–∞–¥–∞ –≤ XP –∑–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É
- `criteria` - –ö—Ä–∏—Ç–µ—Ä–∏–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (JSON –æ–±—ä–µ–∫—Ç)
- `unlocked` - –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –ª–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- `unlockedAt` - –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (null –µ—Å–ª–∏ –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ)

**–ö–æ–¥—ã –æ—à–∏–±–æ–∫:**
- `400` - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä userId
- `404` - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
- `500` - –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

---

## –£—Ç–∏–ª–∏—Ç—ã –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏

–ú–æ–¥—É–ª—å `server/utils/gamification.ts` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏:

### updateStreak(userId, completedToday)

–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `userId` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `completedToday` - –§–ª–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–µ–≥–æ–¥–Ω—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–õ–æ–≥–∏–∫–∞:**
- –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç—Ä–∏–∫ –≤ 1
- –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±—ã–ª–∞ –≤—á–µ—Ä–∞ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—Ç—Ä–∏–∫ –Ω–∞ 1
- –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±—ã–ª–∞ —Å–µ–≥–æ–¥–Ω—è - —Å—Ç—Ä–∏–∫ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
- –ï—Å–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω–æ –±–æ–ª–µ–µ 1 –¥–Ω—è - —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—Ç—Ä–∏–∫ –≤ 1
- –û–±–Ω–æ–≤–ª—è–µ—Ç longestStreak –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–∫ –±–æ–ª—å—à–µ

### calculateLevel(totalXP)

–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–µ–≥–æ XP.

**–§–æ—Ä–º—É–ª–∞:** `level = floor(sqrt(totalXP / 100)) + 1`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `totalXP` - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ XP

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –£—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–∏–Ω–∏–º—É–º 1)

### awardXP(userId, action, metadata)

–ù–∞—á–∏—Å–ª—è–µ—Ç XP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `userId` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `action` - –¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è (—Å–º. XP_REWARDS)
- `metadata` - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –¥–µ–π—Å—Ç–≤–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–¢–∏–ø—ã –¥–µ–π—Å—Ç–≤–∏–π –∏ –Ω–∞–≥—Ä–∞–¥—ã:**
- `CONTACT_ADDED` - 10 XP
- `REMINDER_COMPLETED` - 20 XP
- `STREAK_MAINTAINED` - 5 XP
- `ACHIEVEMENT_UNLOCKED` - 50 XP

### checkAchievements(userId)

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–µ.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `userId` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –ú–∞—Å—Å–∏–≤ –Ω–æ–≤—ã—Ö —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π

**–¢–∏–ø—ã –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤:**
- `minStreak` - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–∫
- `minLevel` - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
- `minXP` - –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ XP
- `minContacts` - –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
- `minRemindersCompleted` - –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π

### unlockAchievement(userId, achievementId)

–†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `userId` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `achievementId` - ID –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –î–∞–Ω–Ω—ã–µ –æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏—Å–ª—è–µ—Ç XP –∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ

---

## Seed –¥–∞–Ω–Ω—ã–µ

–§–∞–π–ª `server/db/seeds/achievements.ts` —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π.

**–ó–∞–ø—É—Å–∫ seed:**
```bash
tsx server/db/seeds/achievements.ts
```

**–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:**
- –ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç (1 –∫–æ–Ω—Ç–∞–∫—Ç)
- –°–æ—Ü–∏–∞–ª—å–Ω–∞—è –±–∞–±–æ—á–∫–∞ (10 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤)
- –ú–∞—Å—Ç–µ—Ä —Å–µ—Ç–µ–π (50 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤)
- –ü–µ—Ä–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (1 –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ)
- –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä (10 –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π)
- –ß–µ–º–ø–∏–æ–Ω —Å–≤—è–∑–µ–π (50 –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π)
- –ù–∞—á–∞–ª–æ —Å–µ—Ä–∏–∏ (—Å—Ç—Ä–∏–∫ 3 –¥–Ω—è)
- –í–æ–∏–Ω –Ω–µ–¥–µ–ª–∏ (—Å—Ç—Ä–∏–∫ 7 –¥–Ω–µ–π)
- –ú–∞—Å—Ç–µ—Ä –º–µ—Å—è—Ü–∞ (—Å—Ç—Ä–∏–∫ 30 –¥–Ω–µ–π)
- –£—Ä–æ–≤–µ–Ω—å 5
- –£—Ä–æ–≤–µ–Ω—å 10
- –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä XP (1000 XP)
- –ú–∞—Å—Ç–µ—Ä XP (5000 XP)

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```typescript
const response = await fetch('/api/gamification/stats?userId=1')
const data = await response.json()
console.log(`–£—Ä–æ–≤–µ–Ω—å: ${data.stats.level}, XP: ${data.stats.totalXP}`)
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π

```typescript
const response = await fetch('/api/gamification/achievements?userId=1')
const data = await response.json()
const unlocked = data.achievements.filter(a => a.unlocked)
console.log(`–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π: ${unlocked.length}`)
```

### –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ XP –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

```typescript
import { awardXP, checkAchievements } from '~/server/utils/gamification'

// –ù–∞—á–∏—Å–ª–∏—Ç—å XP
await awardXP(userId, 'REMINDER_COMPLETED', { reminderId: 123 })

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
const newAchievements = await checkAchievements(userId)
if (newAchievements.length > 0) {
  console.log('–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –Ω–æ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è!')
}
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∏–∫–∞

```typescript
import { updateStreak } from '~/server/utils/gamification'

// –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∏–∫ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
const updatedUser = await updateStreak(userId)
console.log(`–¢–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–∫: ${updatedUser.currentStreak}`)
```
